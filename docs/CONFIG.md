# Configuration Guide

This document explains how configuration works in services generated by `create-go-service`.

## Overview

Generated services use a **hybrid configuration approach** that combines:
- **YAML files** for non-sensitive configuration
- **Environment variables** for secrets and overrides

This approach provides:
- ✅ Easy-to-read configuration files (YAML)
- ✅ Secure secret management (environment variables)
- ✅ Flexibility to override any setting via env vars
- ✅ Version control friendly (secrets are never committed)

## Configuration Loading Order

1. **Load defaults** from `config.yaml`
2. **Override** with environment variables
3. **Load secrets** from environment variables (required)

## File Structure

### `config.yaml` (Non-Sensitive)

This file contains all non-sensitive configuration and is committed to version control.

```yaml
server:
  port: "8080"
  environment: "local"
  enable_reflection: true

database:
  # DynamoDB example
  aws_region: "us-east-1"
  table_name: "my-service"
  endpoint_url: "http://localhost:8000"
  
  # PostgreSQL example
  # host: "localhost"
  # port: 5432
  # database: "my-service"
  # ssl_mode: "disable"

auth:
  token_expiry: "24h"

metrics:
  enabled: true
  path: "/metrics"
```

### `.env` (Secrets)

This file contains sensitive data and is **never committed** to version control (it's in `.gitignore`).

```bash
# Copy from .env.example and fill in your secrets

# PostgreSQL (if using Postgres/Supabase)
DATABASE_URL=postgres://user:password@localhost:5432/mydb?sslmode=disable

# JWT Authentication (if using auth)
JWT_SECRET=your-secret-key-change-this-in-production

# Any other secrets...
```

### `.env.example` (Template)

This file is a template showing what environment variables are needed. It's committed to version control.

## Libraries Used

- **YAML Parsing**: [`gopkg.in/yaml.v3`](https://github.com/go-yaml/yaml)
- **Environment Variables**: [`github.com/caarlos0/env/v10`](https://github.com/caarlos0/env)

## Configuration Struct

The generated `internal/config/config.go` file contains the configuration struct:

```go
type Config struct {
    Server   ServerConfig   `yaml:"server"`
    Database DatabaseConfig `yaml:"database"`
    Auth     AuthConfig     `yaml:"auth"`
    Metrics  MetricsConfig  `yaml:"metrics"`
    
    // Secrets loaded only from environment
    Secrets SecretsConfig `yaml:"-"`
}

type ServerConfig struct {
    Port            string `yaml:"port" env:"PORT" envDefault:"8080"`
    Environment     string `yaml:"environment" env:"ENV" envDefault:"local"`
    EnableReflection bool  `yaml:"enable_reflection" env:"ENABLE_REFLECTION" envDefault:"true"`
}

type SecretsConfig struct {
    DatabaseURL string `env:"DATABASE_URL,required"`
    JWTSecret   string `env:"JWT_SECRET,required"`
}
```

## Usage

### Loading Configuration

```go
// Load from YAML with env overrides (typical usage)
cfg, err := config.Load("config.yaml")
if err != nil {
    log.Fatal(err)
}

// Or load only from environment (useful for containers)
cfg, err := config.LoadFromEnv()
if err != nil {
    log.Fatal(err)
}
```

### Accessing Configuration

```go
// Server config
port := cfg.Server.Port
env := cfg.Server.Environment

// Database config
dbURL := cfg.Secrets.DatabaseURL

// Feature flags
if cfg.Metrics.Enabled {
    // Setup metrics
}
```

## Environment-Specific Configuration

### Local Development

```yaml
# config.yaml
server:
  environment: "local"
  enable_reflection: true  # Enabled for debugging
```

```bash
# .env
ENV=local
ENABLE_REFLECTION=true
DATABASE_URL=postgres://postgres:postgres@localhost:5432/mydb
JWT_SECRET=local-dev-secret
```

### Production

```yaml
# config.yaml
server:
  environment: "production"
  enable_reflection: false  # Disabled for security
```

```bash
# Environment variables (set in Fly.io, Render, etc.)
ENV=production
ENABLE_REFLECTION=false
DATABASE_URL=postgres://user:password@prod-db.example.com:5432/mydb?sslmode=require
JWT_SECRET=<strong-random-secret>
```

## Reflection Configuration

For gRPC services, reflection is automatically controlled:

- **Local**: `ENV=local` → reflection **enabled** (for `grpcurl`, `buf`, etc.)
- **Production**: `ENV=production` → reflection **disabled** (security)
- **Override**: Set `ENABLE_REFLECTION=false` explicitly to disable

## Best Practices

1. **Never commit secrets**
   - Always use `.env` for secrets
   - Keep `.env` in `.gitignore`
   - Use `.env.example` as a template

2. **Use YAML for non-sensitive config**
   - Server settings
   - Feature flags
   - Non-sensitive database settings (host, port)

3. **Use environment variables for:**
   - Secrets (passwords, API keys, JWT secrets)
   - Environment-specific overrides
   - CI/CD deployments

4. **Validation**
   - Use `required` tag for mandatory secrets
   - Use `envDefault` for sensible defaults
   - Validate config after loading

5. **Documentation**
   - Keep `.env.example` up to date
   - Document all configuration options
   - Include examples in README

## Deployment

### Fly.io

Set secrets using `flyctl`:

```bash
flyctl secrets set DATABASE_URL="postgres://..." JWT_SECRET="..."
```

### Render

Set environment variables in the Render dashboard or via CLI.

### Docker

Pass environment variables via `docker run`:

```bash
docker run -e DATABASE_URL="postgres://..." -e JWT_SECRET="..." my-service
```

Or use `docker-compose.yml`:

```yaml
services:
  api:
    image: my-service
    environment:
      - DATABASE_URL=postgres://...
      - JWT_SECRET=...
    # Or use env_file
    env_file:
      - .env
```

## Troubleshooting

### "failed to parse secrets from env"

**Cause**: Required environment variables are missing.

**Solution**: Check that all required secrets are set in `.env` or environment variables.

```bash
# Check .env.example for required variables
cat .env.example

# Copy and fill in secrets
cp .env.example .env
# Edit .env with your secrets
```

### "failed to read config file"

**Cause**: `config.yaml` not found or invalid YAML syntax.

**Solution**: Ensure `config.yaml` exists and is valid YAML.

```bash
# Validate YAML syntax
yamllint config.yaml
```

### Environment variables not overriding YAML

**Cause**: Environment variables are loaded but YAML values take precedence.

**Solution**: Check the struct tags. Environment variables should override YAML when both `yaml` and `env` tags are present.

## Example: Complete Setup

1. **Copy environment template:**
   ```bash
   cp .env.example .env
   ```

2. **Edit `.env` with your secrets:**
   ```bash
   DATABASE_URL=postgres://postgres:postgres@localhost:5432/mydb
   JWT_SECRET=my-secret-key
   ```

3. **Edit `config.yaml` for your environment:**
   ```yaml
   server:
     port: "8080"
     environment: "local"
   ```

4. **Run the service:**
   ```bash
   go run cmd/api/main.go
   ```

The service will:
1. Load `config.yaml`
2. Override with environment variables
3. Load secrets from `.env`
4. Start with the merged configuration


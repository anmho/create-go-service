# create-go-service

A CLI tool that scaffolds production-ready Go microservice boilerplate with a modern TUI interface.

**Note**: This repository serves dual purposes:
1. **CLI Tool**: The `create-go-service` CLI tool (aliased as `cgs`) for generating microservice boilerplate
2. **Example Template**: This repository itself serves as an example of the generated structure

## Features

- üé® **Interactive TUI**: Modern terminal user interface built with Bubbletea
- üöÄ **Multiple API Frameworks**: Chi (REST), gRPC with ConnectRPC
- üíæ **Database Support**: DynamoDB and PostgreSQL
- üìä **Optional Features**: PostHog analytics, JWT authentication, Prometheus metrics
- üóÑÔ∏è **Migrations**: Atlas Go for PostgreSQL migrations
- üê≥ **Docker Support**: Complete Docker and docker-compose setup
- üö¢ **Deployment**: Fly.io configuration with GitHub Actions CI/CD
- üî• **Hot Reload**: wgo for fast development iteration
- ‚úÖ **Testing**: Comprehensive test templates with testcontainers

## Installation

### Homebrew (Recommended)

```bash
# Add the tap
brew tap anmho/tap

# Install create-go-service
brew install create-go-service

# Now you can run it from anywhere
create-go-service
# Or use the shorter alias
cgs
```

To uninstall:

```bash
brew uninstall create-go-service
```

### Manual Installation

```bash
# Install to /usr/local/bin (may require sudo)
make cli-install

# Now you can run it from anywhere
create-go-service
# Or use the shorter alias
cgs
```

To uninstall:

```bash
make cli-uninstall
```

### Running Without Installation

To test the CLI tool without installing:

```bash
# Run directly
go run cmd/create-go-service/main.go

# Or use make
make cli-run

# Or build and run
make cli-build
./bin/create-go-service
# Or use the alias
./bin/cgs
```

## Usage

The CLI will launch an interactive TUI (Text User Interface) where you can:

- Configure project name, module path, and output directory
- Select API framework (Chi or gRPC) - single choice
- Choose database (DynamoDB or PostgreSQL)
- Select optional features (PostHog, JWT Auth) - multi-select
- Configure deployment (Fly.io)

**Navigation:**
- `‚Üë/‚Üì` or `j/k` - Navigate options
- `Space` - Toggle selection (multi-select)
- `Enter` - Confirm and continue
- `Esc` - Go back
- `Ctrl+C` or `q` - Quit

## Generated Service Configuration

Services generated by `create-go-service` use a **stage-based configuration approach**:

### Configuration Files (YAML) - Source of Truth
- **YAML Files**: All non-sensitive configuration per stage - committed to git
  - `local.yaml` - Local development settings
  - `development.yaml` - Development environment settings
  - `production.yaml` - Production settings (embedded in Docker image)
- **No Overrides**: YAML files are the source of truth - environment variables do not override config values

### Environment Variables
- **Config File Selection**: 
  - `STAGE` - Determines which YAML file to load (defaults to "local")
  - `CONFIG_FILE` - Explicit config file path override (defaults to "config.yaml" in production)
- **Secrets Only**: Sensitive data loaded from environment variables
  - `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY` - AWS credentials (DynamoDB)
  - `DATABASE_URL` - PostgreSQL connection string (Postgres)
  - `JWT_SECRET` - JWT signing secret (Auth)
  - `POSTHOG_API_KEY` - PostHog API key (PostHog, optional)

**Setup:**
```bash
# In your generated service directory
cp .env.example .env
# Edit .env with your secrets
```

**Configuration Loading:**
1. Load stage-specific YAML file (based on `STAGE` or `CONFIG_FILE` environment variable)
2. Load secrets from environment variables (required)
3. YAML values are never overridden - they are the source of truth

**Deployment:**
```bash
# Deploy with production config (default)
make deploy

# Deploy with custom config file
make deploy CONFIG_FILE=staging.yaml

# Secrets are automatically set from your local environment if available
# Otherwise set manually: flyctl secrets set AWS_ACCESS_KEY_ID=xxx AWS_SECRET_ACCESS_KEY=yyy
```

See [Configuration Guide](docs/CONFIG.md) for detailed documentation.

## Generated Service Features

### API Frameworks

- **Chi (REST)**: Fast, lightweight HTTP router with middleware support
- **gRPC (ConnectRPC)**: Modern gRPC with HTTP/1.1 and HTTP/2 support, reflection enabled in all stages

### Database Support

- **DynamoDB**: 
  - Automatic table creation with `CreateTableIfNotExists`
  - Local development with DynamoDB Local
  - IAM role support for AWS environments
- **PostgreSQL**:
  - Atlas Go migrations
  - `pgx` driver with native struct scanning
  - Testcontainers for testing

### Optional Features

- **PostHog**: Event tracking and analytics (optional)
- **JWT Auth**: Token-based authentication (optional)
- **Metrics**: Prometheus metrics (always included)
- **Hot Reload**: wgo for development (always included)

### Testing

- Testcontainers for integration tests
- Parallel test execution (`t.Parallel()`)
- DynamoDB Local and PostgreSQL testcontainers
- Comprehensive test coverage

## Development

### Running Tests

```bash
# Run all tests
go test ./...

# Run generator tests specifically
go test -v ./internal/generator/...

# Run a specific test
go test -v ./internal/generator/... -run TestTemplateEmbedding
```

The test suite includes:
- **Template Embedding Tests**: Verify all templates are correctly embedded
- **Template Execution Tests**: Ensure templates execute without errors
- **Project Generation Tests**: End-to-end tests that generate complete projects
- **Template Data Tests**: Validate template data mapping
- **Parallel Execution**: All tests run in parallel for faster execution

### Project Structure

```
create-go-service/
‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îî‚îÄ‚îÄ create-go-service/        # CLI tool entry point
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ cli/                       # CLI command handlers
‚îÇ   ‚îú‚îÄ‚îÄ tui/                       # Bubbletea TUI components
‚îÇ   ‚îú‚îÄ‚îÄ generator/                 # Code generation logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/             # Embedded template files
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ project.go             # Project structure generator
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ templates.go           # Template loading
‚îÇ   ‚îî‚îÄ‚îÄ [other packages]
‚îú‚îÄ‚îÄ docs/                          # Documentation
‚îî‚îÄ‚îÄ README.md                      # This file
```

## Architecture

The generator uses:

- **Embedded Templates**: All templates are embedded in the binary using `//go:embed`
- **Template System**: Go's `text/template` package for code generation
- **Stage-Based Config**: YAML files per stage with environment variable secrets
- **Provider Agnostic**: Database implementations are provider-agnostic

See [Design Document](docs/DESIGN.md) for detailed architecture information.

## Releasing

Releases are automated using [GoReleaser](https://goreleaser.com/). To create a new release:

1. **Create and push a tag:**
   ```bash
   git tag -a v1.0.0 -m "Release v1.0.0"
   git push origin v1.0.0
   ```

2. **Or use the Makefile:**
   ```bash
   make release TAG=v1.0.0
   ```

3. **GitHub Actions will automatically:**
   - Build binaries for all platforms (Linux, macOS, Windows)
   - Create a GitHub release with changelog
   - Update the Homebrew formula in `anmho/homebrew-tap`
   - Generate checksums

To test a release locally:

```bash
# Install GoReleaser
brew install goreleaser

# Test snapshot release
make snapshot
```

The Homebrew formula will be automatically updated in your `anmho/homebrew-tap` repository when you push a tag.

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests for new functionality
5. Ensure all tests pass
6. Submit a pull request

## License

MIT License - see LICENSE file for details.
